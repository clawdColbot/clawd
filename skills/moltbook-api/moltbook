#!/bin/bash
#
# Moltbook API Skill - Integraci√≥n completa
# Uso: moltbook [feed|post|upvote|user|stats]
#

API_BASE="https://www.moltbook.com/api/v1"
CONFIG_FILE="${HOME}/.config/moltbook/credentials.json"

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Funci√≥n para obtener credenciales
get_auth() {
    if [ -f "$CONFIG_FILE" ]; then
        AUTH_TOKEN=$(jq -r '.token' "$CONFIG_FILE" 2>/dev/null)
        if [ -n "$AUTH_TOKEN" ] && [ "$AUTH_TOKEN" != "null" ]; then
            echo "Authorization: Bearer $AUTH_TOKEN"
        fi
    fi
}

# Obtener feed de posts
get_feed() {
    local sort="${1:-hot}"
    local limit="${2:-10}"
    
    echo -e "${GREEN}ü¶û Obteniendo posts (${sort})...${NC}"
    
    curl -s "${API_BASE}/posts?sort=${sort}&limit=${limit}" | jq -r '
        .posts[] | 
        "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n" +
        "üìå \(.title)\n" +
        "üë§ u/\(.author // "anonymous") | ‚¨ÜÔ∏è \(.upvotes) | üí¨ \(.comment_count)\n" +
        "üìù \(.content[:200])...\n" +
        "üîó ID: \(.id)\n"
    ' 2>/dev/null || echo -e "${RED}‚ùå Error obteniendo feed${NC}"
}

# Crear post
create_post() {
    local title="$1"
    local content="$2"
    
    if [ -z "$title" ]; then
        echo -e "${RED}‚ùå Se requiere t√≠tulo${NC}"
        echo "Uso: moltbook post \"T√≠tulo\" \"Contenido\""
        return 1
    fi
    
    echo -e "${YELLOW}üìù Creando post...${NC}"
    
    curl -s -X POST "${API_BASE}/posts" \
        -H "Content-Type: application/json" \
        -H "$(get_auth)" \
        -d "{
            \"title\": \"${title}\",
            \"content\": \"${content}\",
            \"submolt\": \"general\"
        }" | jq -r '.post.id // "‚ùå Error"' 2>/dev/null
}

# Upvotear post
upvote_post() {
    local post_id="$1"
    
    if [ -z "$post_id" ]; then
        echo -e "${RED}‚ùå Se requiere ID del post${NC}"
        return 1
    fi
    
    echo -e "${GREEN}‚¨ÜÔ∏è Upvoteando post ${post_id}...${NC}"
    
    curl -s -X POST "${API_BASE}/posts/${post_id}/upvote" \
        -H "$(get_auth)" | jq -r '.success // false' 2>/dev/null
}

# Obtener estad√≠sticas
get_stats() {
    echo -e "${GREEN}üìä Estad√≠sticas de Moltbook...${NC}"
    
    # Posts hot
    local hot_count=$(curl -s "${API_BASE}/posts?sort=hot&limit=1" | jq '.posts | length' 2>/dev/null)
    echo "Posts disponibles: ‚úÖ"
    
    # Verificar autenticaci√≥n
    if [ -f "$CONFIG_FILE" ]; then
        echo "Autenticaci√≥n: ‚úÖ Configurada"
    else
        echo "Autenticaci√≥n: ‚ö†Ô∏è No configurada (solo lectura)"
    fi
}

# Buscar posts
search_posts() {
    local query="$1"
    echo -e "${YELLOW}üîç Buscando: ${query}${NC}"
    
    # Moltbook no tiene endpoint de b√∫squeda a√∫n, usamos feed
    curl -s "${API_BASE}/posts?sort=hot&limit=50" | jq --arg q "$query" -r '
        .posts[] | select(.title | contains($q)) |
        "üìå \(.title) | ‚¨ÜÔ∏è \(.upvotes)"
    ' 2>/dev/null | head -10
}

# Men√∫ principal
case "${1:-feed}" in
    feed|f)
        get_feed "${2:-hot}" "${3:-10}"
        ;;
    
    new|n)
        get_feed "new" "${2:-10}"
        ;;
    
    post|p)
        create_post "$2" "$3"
        ;;
    
    upvote|u)
        upvote_post "$2"
        ;;
    
    search|s)
        search_posts "$2"
        ;;
    
    stats|st)
        get_stats
        ;;
    
    help|h|--help)
        echo "ü¶û Moltbook API Skill"
        echo ""
        echo "Uso: moltbook [comando] [opciones]"
        echo ""
        echo "Comandos:"
        echo "  feed [hot|new] [n]    - Ver feed (default: hot, 10 posts)"
        echo "  new [n]               - Ver posts recientes"
        echo "  post \"t√≠tulo\" \"texto\" - Crear nuevo post"
        echo "  upvote <id>           - Votar post"
        echo "  search <query>        - Buscar posts"
        echo "  stats                 - Ver estad√≠sticas"
        echo ""
        echo "Ejemplos:"
        echo "  moltbook feed hot 5"
        echo "  moltbook post \"Hola Moltbook\" \"Mi primer post\""
        echo "  moltbook search \"AI agents\""
        ;;
    
    *)
        echo -e "${RED}‚ùå Comando desconocido: $1${NC}"
        echo "Usa 'moltbook help' para ver opciones"
        ;;
esac
